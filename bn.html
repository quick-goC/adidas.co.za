<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Book Scanner Upload</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    .step { display: none; }
    .step.active { display: block; }
    #videoContainer { position: relative; display: inline-block; margin: 20px 0; }
    video, canvas {
      width: 100%; max-width: 400px;
      border: 3px solid #333; border-radius: 8px;
    }
    .scanner-line {
      position: absolute; left: 0; width: 100%; height: 4px;
      background: limegreen;
      animation: scan 3s linear forwards;
    }
    @keyframes scan { from { top: 0 } to { top: 90% } }
    button {
      padding: 12px 24px; font-size: 16px; margin-top: 10px;
      cursor: pointer;
    }
  </style>
</head>
<body>

  <!-- STEP 1: Front -->
  <div id="step1" class="step active">
    <h2>ðŸ“– Front Picture</h2>
    <p>Scan your book to upload to your account.</p>
    <div id="videoContainer1">
      <video id="video1" autoplay playsinline muted></video>
      <div id="scanner1" class="scanner-line" style="display:none"></div>
    </div>
    <canvas id="canvas1" style="display:none"></canvas>
    <br>
    <button id="btn1">ðŸ“¸ Scan Front Book</button>
  </div>

  <!-- STEP 2: Back -->
  <div id="step2" class="step">
    <h2>ðŸ“˜ Back Picture</h2>
    <p>Scan the back of your book to upload to your account.</p>
    <div id="videoContainer2">
      <video id="video2" autoplay playsinline muted></video>
      <div id="scanner2" class="scanner-line" style="display:none"></div>
    </div>
    <canvas id="canvas2" style="display:none"></canvas>
    <br>
    <button id="btn2">ðŸ“¸ Scan Back Book</button>
  </div>

<script>
// â€”â€”â€” Baserow API configuration â€”â€”â€”
const BASEROW_TOKEN = 'LG6hnTBxgBG78FueElsSwpHRd4Wep1oL';
const BASEROW_BASE = 'https://api.baserow.io';
const TABLE_ID      = '503285';
async function uploadToBaserow(blob) {
  // 1) upload file
  const fd = new FormData();
  fd.append('file', blob, 'scan.png');
  const up = await fetch(`${BASEROW_BASE}/api/user-files/upload/`, {
    method: 'POST',
    headers: { Authorization: `Token ${BASEROW_TOKEN}` },
    body: fd
  });
  const { url } = await up.json();
  // 2) create row linking that file
  const row = await fetch(
    `${BASEROW_BASE}/api/database/rows/table/${TABLE_ID}/?user_field_names=true`, {
      method: 'POST',
      headers: {
        Authorization: `Token ${BASEROW_TOKEN}`,
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({ file: [url] })
    }
  );
  return row.ok;
}

// â€”â€”â€” Scanner flow â€”â€”â€”
let currentStream;
async function startCamera(videoEl) {
  currentStream = await navigator.mediaDevices.getUserMedia({ video: true });
  videoEl.srcObject = currentStream;
  await new Promise(r => videoEl.onloadedmetadata = r);
}
function stopCamera() {
  if (currentStream) currentStream.getTracks().forEach(t => t.stop());
}

// side = 1 or 2
async function scanAndUpload(side) {
  const video   = document.getElementById(`video${side}`);
  const canvas  = document.getElementById(`canvas${side}`);
  const scanner = document.getElementById(`scanner${side}`);
  const btn     = document.getElementById(`btn${side}`);

  btn.disabled = true;
  try {
    // 1) request permission & start preview
    await startCamera(video);
    // 2) play scan animation
    scanner.style.display = 'block';
    await new Promise(r => setTimeout(r, 3000));
    scanner.style.display = 'none';
    // 3) capture
    canvas.width  = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext('2d').drawImage(video, 0, 0);
    const blob = await (await fetch(canvas.toDataURL('image/png'))).blob();
    // 4) upload
    const ok = await uploadToBaserow(blob);
    stopCamera();
    if (!ok) throw new Error('upload failed');
    // 5) advance
    if (side === 1) {
      document.getElementById('step1').classList.remove('active');
      document.getElementById('step2').classList.add('active');
    } else {
      alert('âœ… Both images uploaded successfully!');
    }
  } catch (e) {
    stopCamera();
    btn.disabled = false;
    alert('Error: ' + e.message);
  }
}

// â€”â€”â€” Event handlers â€”â€”â€”
document.getElementById('btn1').onclick = () => scanAndUpload(1);
document.getElementById('btn2').onclick = () => scanAndUpload(2);
</script>

</body>
</html>

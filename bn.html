<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Two-Step Book Scanner</title>
  <style>
    body { font-family: sans-serif; text-align: center; padding: 20px; }
    .step { display: none; }
    .step.active { display: block; }
    #videoContainer { position: relative; display: inline-block; margin: 20px 0; }
    video, canvas {
      width: 100%; max-width: 400px;
      border: 3px solid #333; border-radius: 8px;
    }
    .scanner-line {
      position: absolute; left: 0; width: 100%; height: 4px;
      background: limegreen; animation: scan 3s linear forwards;
    }
    @keyframes scan { from { top: 0 } to { top: 90% } }
    button {
      padding: 12px 24px; font-size: 16px; cursor: pointer; margin-top: 10px;
    }
  </style>
</head>
<body>

  <!-- STEP 1: Front -->
  <div id="step1" class="step active">
    <h2>ðŸ“– Front Picture</h2>
    <p>Click below to scan the front of your book.</p>
    <div id="videoContainer">
      <video id="video1" autoplay playsinline muted></video>
      <div id="scanner1" class="scanner-line" style="display:none"></div>
    </div>
    <canvas id="canvas1" style="display:none"></canvas>
    <br>
    <button id="btn1">ðŸ“¸ Scan Front Book</button>
  </div>

  <!-- STEP 2: Back -->
  <div id="step2" class="step">
    <h2>ðŸ“˜ Back Picture</h2>
    <p>Click below to scan the back of your book.</p>
    <div id="videoContainer">
      <video id="video2" autoplay playsinline muted></video>
      <div id="scanner2" class="scanner-line" style="display:none"></div>
    </div>
    <canvas id="canvas2" style="display:none"></canvas>
    <br>
    <button id="btn2">ðŸ“¸ Scan Back Book</button>
  </div>

<script>
// â€”â€”â€” CONFIG â€”â€”â€”
const TOKEN    = 'LG6hnTBxgBG78FueElsSwpHRd4Wep1oL';
const BASE_URL = 'https://api.baserow.io';
const TABLE_ID = '209047';  // your adidas table

// Start/stop camera
let stream;
async function startCamera(videoEl) {
  stream = await navigator.mediaDevices.getUserMedia({ video: true });
  videoEl.srcObject = stream;
  await new Promise(r => videoEl.onloadedmetadata = r);
}
function stopCamera() {
  if (stream) stream.getTracks().forEach(t => t.stop());
}

// Capture to {name,data} inline file
async function captureImage(videoEl, name) {
  const canvas = document.createElement('canvas');
  canvas.width  = videoEl.videoWidth;
  canvas.height = videoEl.videoHeight;
  canvas.getContext('2d').drawImage(videoEl, 0, 0);
  const dataUrl = canvas.toDataURL('image/png');
  return { name, data: dataUrl.split(',')[1] };
}

// Create row with inline Base64 file
async function createRow(payload) {
  const res = await fetch(
    `${BASE_URL}/api/database/rows/table/${TABLE_ID}/?user_field_names=true`, {
      method: 'POST',
      headers: {
        'Authorization': `Token ${TOKEN}`,
        'Content-Type':  'application/json'
      },
      body: JSON.stringify(payload)
    }
  );
  if (!res.ok) throw new Error(`Row creation failed (${res.status})`);
}

// One scan step
async function scanStep(step) {
  const video   = document.getElementById(`video${step}`);
  const scanner = document.getElementById(`scanner${step}`);
  const button  = document.getElementById(`btn${step}`);
  button.disabled = true;

  try {
    await startCamera(video);
    scanner.style.display = 'block';
    await new Promise(r => setTimeout(r, 3000));
    scanner.style.display = 'none';

    const field = step === 1 ? 'file' : 'back_cover';
    const file  = await captureImage(video, `${field}.png`);
    stopCamera();

    await createRow({ [field]: [file] });

    if (step === 1) {
      document.getElementById('step1').classList.remove('active');
      document.getElementById('step2').classList.add('active');
    } else {
      alert('âœ… Both images uploaded successfully!');
    }
  } catch (e) {
    stopCamera();
    button.disabled = false;
    alert('Error: ' + e.message);
  }
}

// Bind events
document.getElementById('btn1').onclick = () => scanStep(1);
document.getElementById('btn2').onclick = () => scanStep(2);
</script>

</body>
</html>

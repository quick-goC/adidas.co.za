<!DOCTYPE html>
<html>
<head>
    <style>
        .page { display: none; }
        .active { display: block; }
        #scanning-animation {
            position: relative;
            overflow: hidden;
        }
        .scan-overlay {
            position: absolute;
            width: 100%;
            height: 100%;
            background: linear-gradient(transparent 0%, rgba(0,255,0,0.3) 50%, transparent 100%);
            animation: scan 2s infinite;
            pointer-events: none;
        }
        @keyframes scan {
            0% { top: -100%; }
            100% { top: 100%; }
        }
        .preview { max-width: 300px; }
    </style>
</head>
<body>
    <!-- Front Page -->
    <div id="front-page" class="page active">
        <h1>Front Cover</h1>
        <p>Scan your book to upload to your account</p>
        <div id="scanning-animation">
            <video id="front-video" playsinline autoplay></video>
            <canvas id="front-canvas" style="display: none;"></canvas>
            <div class="scan-overlay" style="display: none;"></div>
        </div>
        <button id="scan-front-btn">Scan Book to Upload</button>
        <button id="next-btn" style="display: none;">Next</button>
    </div>

    <!-- Back Page -->
    <div id="back-page" class="page">
        <h1>Back Cover</h1>
        <div id="scanning-animation-back">
            <video id="back-video" playsinline autoplay></video>
            <canvas id="back-canvas" style="display: none;"></canvas>
            <div class="scan-overlay" style="display: none;"></div>
        </div>
        <button id="scan-back-btn">Scan Back Book to Upload</button>
        <button id="finish-btn" style="display: none;">Finish</button>
    </div>

    <script>
        const config = {
            token: 'LG6hnTBxgBG78FueElsSwpHRd4Wep1oL',
            baseUrl: 'https://api.baserow.io',
            databaseId: '209047',
            tableId: '503285'
        };

        let currentStream = null;
        let currentRowId = null;
        let frontImageData = null;
        let backImageData = null;

        // Front Page Logic
        document.getElementById('scan-front-btn').addEventListener('click', () => {
            initCamera('front-video', 'front-canvas', 'scan-front-btn', 'next-btn', 'front');
        });

        document.getElementById('next-btn').addEventListener('click', async () => {
            await sendImageToBaserow(frontImageData, 'front_cover');
            switchPage('front-page', 'back-page');
        });

        // Back Page Logic
        document.getElementById('scan-back-btn').addEventListener('click', () => {
            initCamera('back-video', 'back-canvas', 'scan-back-btn', 'finish-btn', 'back');
        });

        document.getElementById('finish-btn').addEventListener('click', async () => {
            await sendImageToBaserow(backImageData, 'back_cover');
            alert('Upload complete!');
        });

        async function initCamera(videoId, canvasId, scanBtnId, nextBtnId, type) {
            try {
                const video = document.getElementById(videoId);
                const canvas = document.getElementById(canvasId);
                const scanBtn = document.getElementById(scanBtnId);
                const nextBtn = document.getElementById(nextBtnId);
                
                if (currentStream) {
                    currentStream.getTracks().forEach(track => track.stop());
                }

                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                currentStream = stream;
                video.srcObject = stream;

                document.querySelector(`#${videoId} + .scan-overlay`).style.display = 'block';
                scanBtn.disabled = true;
                
                setTimeout(async () => {
                    const context = canvas.getContext('2d');
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const imageData = canvas.toDataURL('image/jpeg');
                    
                    if (type === 'front') frontImageData = imageData;
                    if (type === 'back') backImageData = imageData;

                    video.style.display = 'none';
                    canvas.style.display = 'block';
                    document.querySelector(`#${videoId} + .scan-overlay`).style.display = 'none';
                    nextBtn.style.display = 'block';
                    scanBtn.disabled = false;
                }, 2000);

            } catch (error) {
                alert('Error accessing camera: ' + error.message);
            }
        }

        async function sendImageToBaserow(imageData, fieldName) {
            try {
                // Convert data URL to Blob
                const blob = await (await fetch(imageData)).blob();
                
                // Upload file
                const formData = new FormData();
                formData.append('file', blob, 'cover.jpg');
                
                const uploadResponse = await fetch(`${config.baseUrl}/api/database/files/upload-file/`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Token ${config.token}`
                    },
                    body: formData
                });

                const fileData = await uploadResponse.json();
                
                // Create or update row
                const endpoint = currentRowId 
                    ? `/api/database/rows/table/${config.tableId}/${currentRowId}/`
                    : `/api/database/rows/table/${config.tableId}/`;

                const rowResponse = await fetch(`${config.baseUrl}${endpoint}`, {
                    method: currentRowId ? 'PATCH' : 'POST',
                    headers: {
                        'Authorization': `Token ${config.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        [fieldName]: [fileData.id]
                    })
                });

                const rowData = await rowResponse.json();
                if (!currentRowId) currentRowId = rowData.id;
                
            } catch (error) {
                console.error('Upload failed:', error);
                alert('Upload failed. Please try again.');
            }
        }

        function switchPage(hideId, showId) {
            document.getElementById(hideId).classList.remove('active');
            document.getElementById(showId).classList.add('active');
        }
    </script>
</body>
</html>
